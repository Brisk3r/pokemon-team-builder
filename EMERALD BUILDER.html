<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon Emerald Team Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .pokemon-card {
            border: 4px solid #4a5568;
            background-color: #161b22;
            transition: all 0.2s ease-in-out;
        }
        .pokemon-card:hover {
            border-color: #a0aec0;
            transform: translateY(-4px);
        }
        .team-slot.empty {
            border: 4px dashed #4a5568;
            background-color: rgba(22, 27, 34, 0.5);
        }
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
        .normal { background-color: #A8A77A; } .fire { background-color: #EE8130; }
        .water { background-color: #6390F0; } .electric { background-color: #F7D02C; }
        .grass { background-color: #7AC74C; } .ice { background-color: #96D9D6; }
        .fighting { background-color: #C22E28; } .poison { background-color: #A33EA1; }
        .ground { background-color: #E2BF65; } .flying { background-color: #A98FF3; }
        .psychic { background-color: #F95587; } .bug { background-color: #A6B91A; }
        .rock { background-color: #B6A136; } .ghost { background-color: #735797; }
        .dragon { background-color: #6F35FC; } .dark { background-color: #705746; }
        .steel { background-color: #B7B7CE; }
        .stat-bar-bg { background-color: #2d3748; }
        .stat-bar { background: linear-gradient(to right, #e53e3e, #f6e05e, #48bb78); transition: width 0.5s ease-out; }
        .analysis-bar { transition: width 0.3s ease-in-out; }
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-panel { transition: transform 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .image-rendering-pixelated { image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
        .stat-up { color: #48bb78; }
        .stat-down { color: #e53e3e; }
        .toast {
            transition: opacity 0.3s, transform 0.3s;
        }
        .mobile-tab.active {
            background-color: #fbbF24; /* yellow-400 */
            color: #161b22;
        }
        details > summary {
            cursor: pointer;
            padding: 0.5rem;
            background-color: #2d3748;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        details[open] > summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .evolution-arrow {
            font-size: 1.5rem;
            color: #9ca3af;
        }
    </style>
</head>

<body class="p-4 md:p-8 pb-24 lg:pb-8">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex flex-col justify-center items-center z-50">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-16 h-16 animate-spin image-rendering-pixelated" alt="Pokeball">
        <p class="text-xl mt-4">Loading Game Data...</p>
        <p id="loading-progress" class="text-sm text-gray-400 mt-2">Initializing...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 toast z-40">
        <p id="toast-message"></p>
    </div>

    <div class="container mx-auto max-w-screen-xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-bold text-yellow-300 tracking-wider">Pokémon Emerald Team Builder</h1>
            <p class="text-gray-400 mt-2">Build the ultimate team for your Emerald playthrough!</p>
        </header>

        <!-- Team Section -->
        <section id="team-section" class="mb-8">
             <div class="flex justify-between items-center mb-4 border-b-2 border-gray-600 pb-2">
                 <h2 class="text-2xl text-center flex-grow">Your Team (Auto-saves)</h2>
                 <button id="clear-team-btn" class="p-2 text-sm rounded bg-red-600 text-white hover:bg-red-500">Clear Team</button>
            </div>
            <div id="team-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4"></div>
        </section>

        <!-- Main Content Grid -->
        <main id="main-content" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8">
                 <div id="builder-view" class="view-panel">
                    <div id="pokemon-list-container" class="p-4 border-4 border-gray-700 rounded-lg bg-[#161b22]">
                        <h3 class="text-xl mb-4 text-center">Choose Pokémon (Hoenn Dex)</h3>
                        <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="text" id="search-pokemon" placeholder="Search by name..." class="w-full p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                            <select id="type-filter" class="w-full sm:w-48 p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                                <option value="all">All Types</option>
                            </select>
                        </div>
                        <div id="pokemon-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto p-2"></div>
                    </div>
                </div>
                 <div id="details-view" class="view-panel hidden lg:block">
                    <div id="details-section" class="p-4 border-4 border-gray-700 rounded-lg bg-[#161b22] lg:sticky top-8">
                        <div id="details-placeholder" class="flex flex-col items-center justify-center h-full text-gray-500 min-h-[400px]">
                            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png" class="w-24 h-24 opacity-50 image-rendering-pixelated" alt="Ultra Ball">
                            <p class="mt-4 text-center">Select a Pokémon from your team to see its details</p>
                        </div>
                        <div id="details-content" class="hidden"></div>
                    </div>
                </div>
            </div>
            <div id="analysis-view" class="view-panel hidden lg:block lg:col-span-4">
                <div id="analysis-section" class="p-4 border-4 border-gray-700 rounded-lg bg-[#161b22] lg:sticky top-8">
                    <h3 class="text-xl mb-4 text-center">Battle Analysis</h3>
                    <div id="team-analysis-content" class="space-y-4"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Tab Navigation -->
    <nav id="mobile-nav" class="lg:hidden fixed bottom-0 left-0 right-0 bg-[#161b22] border-t-2 border-yellow-400 flex justify-around p-2 z-30">
        <button data-view="builder-view" class="mobile-tab flex-1 p-2 rounded-md text-sm">Builder</button>
        <button data-view="details-view" class="mobile-tab flex-1 p-2 rounded-md text-sm">Details</button>
        <button data-view="analysis-view" class="mobile-tab flex-1 p-2 rounded-md text-sm">Analysis</button>
    </nav>

    <!-- Move Selection Modal -->
    <div id="move-modal" class="fixed inset-0 z-40 overflow-y-auto hidden">
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-75"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div id="modal-panel" class="relative bg-[#0d1117] border-4 border-yellow-400 rounded-lg w-full max-w-4xl mx-auto p-6 transform scale-95">
                <div id="modal-content"></div>
                <button id="close-modal-btn" class="absolute top-2 right-2 text-white bg-red-600 hover:bg-red-700 rounded-full w-8 h-8 flex items-center justify-center font-mono">×</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS AND STATE ---
            const EMERALD_HOENN_DEX_IDS = [252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 41, 42, 63, 64, 65, 77, 78, 92, 93, 94, 108, 111, 112, 115, 123, 127, 129, 130, 201, 215, 225, 227, 235, 241, 60, 61, 62, 72, 73, 79, 80, 199, 90, 91, 116, 117, 230, 120, 121, 131, 138, 139, 140, 141, 142, 179, 180, 181, 183, 184, 194, 195, 211, 222, 223, 224, 226, 43, 44, 45, 182, 69, 70, 71, 84, 85, 102, 103, 113, 242, 114, 128, 175, 176, 193, 203, 206, 214, 216, 217, 234];
            const HELD_ITEMS = {'None': 'none', 'Leftovers': 'leftovers', 'Choice Band': 'choice-band', 'Lum Berry': 'lum-berry', 'Salac Berry': 'salac-berry', 'Petaya Berry': 'petaya-berry', 'Liechi Berry': 'liechi-berry', 'White Herb': 'white-herb', 'Focus Band': 'focus-band', 'Scope Lens': 'scope-lens', 'Quick Claw': 'quick-claw', "King's Rock": 'kings-rock', 'Bright Powder': 'bright-powder', 'Shell Bell': 'shell-bell', 'Macho Brace': 'macho-brace', 'Soothe Bell': 'soothe-bell', 'Black Belt': 'black-belt', 'Black Glasses': 'black-glasses', 'Charcoal': 'charcoal', 'Dragon Fang': 'dragon-fang', 'Hard Stone': 'hard-stone', 'Magnet': 'magnet', 'Metal Coat': 'metal-coat', 'Miracle Seed': 'miracle-seed', 'Mystic Water': 'mystic-water', 'Never-Melt Ice': 'never-melt-ice', 'Poison Barb': 'poison-barb', 'Sharp Beak': 'sharp-beak', 'Silk Scarf': 'silk-scarf', 'Silver Powder': 'silver-powder', 'Soft Sand': 'soft-sand', 'Spell Tag': 'spell-tag', 'Twisted Spoon': 'twisted-spoon'};
            const NATURES = { 'Hardy': { inc: null, dec: null }, 'Lonely': { inc: 'attack', dec: 'defense' }, 'Brave': { inc: 'attack', dec: 'speed' }, 'Adamant': { inc: 'attack', dec: 'special-attack' }, 'Naughty': { inc: 'attack', dec: 'special-defense' }, 'Bold': { inc: 'defense', dec: 'attack' }, 'Docile': { inc: null, dec: null }, 'Relaxed': { inc: 'defense', dec: 'speed' }, 'Impish': { inc: 'defense', dec: 'special-attack' }, 'Lax': { inc: 'defense', dec: 'special-defense' }, 'Timid': { inc: 'speed', dec: 'attack' }, 'Hasty': { inc: 'speed', dec: 'defense' }, 'Serious': { inc: null, dec: null }, 'Jolly': { inc: 'speed', dec: 'special-attack' }, 'Naive': { inc: 'speed', dec: 'special-defense' }, 'Modest': { inc: 'special-attack', dec: 'attack' }, 'Mild': { inc: 'special-attack', dec: 'defense' }, 'Quiet': { inc: 'special-attack', dec: 'speed' }, 'Bashful': { inc: null, dec: null }, 'Rash': { inc: 'special-attack', dec: 'special-defense' }, 'Calm': { inc: 'special-defense', dec: 'attack' }, 'Gentle': { inc: 'special-defense', dec: 'defense' }, 'Sassy': { inc: 'special-defense', dec: 'speed' }, 'Careful': { inc: 'special-defense', dec: 'special-attack' }, 'Quirky': { inc: null, dec: null } };
            const allPokemonData = [];
            const moveDataCache = new Map();
            const abilityDataCache = new Map();
            const extraDataCache = new Map();
            let team = Array(6).fill(null);
            const TYPE_CHART = { normal: { weak: ['fighting'], resist: [], immune: ['ghost'] }, fire: { weak: ['water', 'ground', 'rock'], resist: ['fire', 'grass', 'ice', 'bug', 'steel'], immune: [] }, water: { weak: ['electric', 'grass'], resist: ['fire', 'water', 'ice', 'steel'], immune: [] }, electric: { weak: ['ground'], resist: ['electric', 'flying', 'steel'], immune: [] }, grass: { weak: ['fire', 'ice', 'poison', 'flying', 'bug'], resist: ['water', 'electric', 'grass', 'ground'], immune: [] }, ice: { weak: ['fire', 'fighting', 'rock', 'steel'], resist: ['ice'], immune: [] }, fighting: { weak: ['flying', 'psychic'], resist: ['bug', 'rock', 'dark'], immune: [] }, poison: { weak: ['ground', 'psychic'], resist: ['grass', 'fighting', 'poison', 'bug'], immune: [] }, ground: { weak: ['water', 'grass', 'ice'], resist: ['poison', 'rock'], immune: ['electric'] }, flying: { weak: ['electric', 'ice', 'rock'], resist: ['grass', 'fighting', 'bug'], immune: ['ground'] }, psychic: { weak: ['bug', 'ghost', 'dark'], resist: ['fighting', 'psychic'], immune: [] }, bug: { weak: ['fire', 'flying', 'rock'], resist: ['grass', 'fighting', 'ground'], immune: [] }, rock: { weak: ['water', 'grass', 'fighting', 'ground', 'steel'], resist: ['normal', 'fire', 'poison', 'flying'], immune: [] }, ghost: { weak: ['ghost', 'dark'], resist: ['poison', 'bug'], immune: ['normal', 'fighting'] }, dragon: { weak: ['ice', 'dragon'], resist: ['fire', 'water', 'electric', 'grass'], immune: [] }, dark: { weak: ['fighting', 'bug'], resist: ['ghost', 'dark'], immune: ['psychic'] }, steel: { weak: ['fire', 'fighting', 'ground'], resist: ['normal', 'grass', 'ice', 'flying', 'psychic', 'bug', 'rock', 'dragon', 'steel'], immune: ['poison'] } };
            const GEN3_SPECIAL_TYPES = ['fire', 'water', 'grass', 'electric', 'ice', 'psychic', 'dragon', 'dark'];
            
            // --- DOM ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay'), loadingProgress = document.getElementById('loading-progress'), teamContainer = document.getElementById('team-container'), pokemonList = document.getElementById('pokemon-list'), searchInput = document.getElementById('search-pokemon'), typeFilter = document.getElementById('type-filter'), detailsPlaceholder = document.getElementById('details-placeholder'), detailsContent = document.getElementById('details-content'), teamAnalysisContent = document.getElementById('team-analysis-content'), moveModal = document.getElementById('move-modal'), modalBackdrop = document.getElementById('modal-backdrop'), modalPanel = document.getElementById('modal-panel'), modalContent = document.getElementById('modal-content'), closeModalBtn = document.getElementById('close-modal-btn'), clearTeamBtn = document.getElementById('clear-team-btn'), toast = document.getElementById('toast'), toastMessage = document.getElementById('toast-message'), mobileNav = document.getElementById('mobile-nav');

            // --- DATA FETCHING & INITIALIZATION ---
            async function fetchGameData() {
                try {
                    const cachedPokemon = localStorage.getItem('gen3EmeraldHoennDexData');
                    const cachedAbilities = localStorage.getItem('gen3AbilityData');
                    if (cachedPokemon && cachedAbilities) {
                        allPokemonData.push(...JSON.parse(cachedPokemon));
                        const abilities = JSON.parse(cachedAbilities);
                        abilities.forEach(ability => abilityDataCache.set(ability.name, ability));
                        loadingProgress.textContent = `Loaded ${allPokemonData.length} Pokémon and ${abilityDataCache.size} abilities from cache.`;
                        return;
                    }
                    loadingProgress.textContent = 'Fetching Pokémon data...';
                    const pokemonPromises = EMERALD_HOENN_DEX_IDS.map(id => fetch(`https://pokeapi.co/api/v2/pokemon/${id}`).then(res => res.json()));
                    const pokemonResults = await Promise.all(pokemonPromises);
                    const abilityUrls = new Set();
                    for (const data of pokemonResults) {
                        const moves = [];
                        const seenMoves = new Set();
                        data.moves.forEach(moveData => {
                            const moveName = moveData.move.name;
                            if (seenMoves.has(moveName)) return;

                            const emeraldDetails = moveData.version_group_details.find(d => d.version_group.name === 'emerald');
                            if (emeraldDetails) {
                                seenMoves.add(moveName);
                                moves.push({
                                    name: moveName,
                                    method: emeraldDetails.move_learn_method.name,
                                    level: emeraldDetails.level_learned_at
                                });
                            }
                        });
                        
                        moves.sort((a, b) => {
                            if (a.method === 'level-up' && b.method === 'level-up') {
                                return a.level - b.level;
                            }
                            return a.name.localeCompare(b.name);
                        });

                        const abilities = data.abilities.map(a => {
                            abilityUrls.add(a.ability.url);
                            return a.ability.name;
                        });
                        allPokemonData.push({ id: data.id, name: data.name, nickname: data.name, sprite: data.sprites.front_default, types: data.types.map(t => t.type.name), stats: data.stats.map(s => ({ name: s.stat.name, base_stat: s.base_stat })), abilities: abilities, selectedAbility: abilities[0], moves: moves, selectedMoves: [], heldItem: 'none', nature: 'Hardy' });
                    }
                    allPokemonData.sort((a, b) => a.id - b.id);
                    loadingProgress.textContent = `Fetching ${abilityUrls.size} ability details...`;
                    const abilityPromises = [...abilityUrls].map(url => fetch(url).then(res => res.json()));
                    const abilityResults = await Promise.all(abilityPromises);
                    const abilityStorage = [];
                    for (const data of abilityResults) {
                        const effectEntry = data.effect_entries.find(e => e.language.name === 'en');
                        const ability = { name: data.name, description: effectEntry ? effectEntry.short_effect : 'No description available.' };
                        abilityDataCache.set(data.name, ability);
                        abilityStorage.push(ability);
                    }
                    localStorage.setItem('gen3EmeraldHoennDexData', JSON.stringify(allPokemonData));
                    localStorage.setItem('gen3AbilityData', JSON.stringify(abilityStorage));
                } catch (error) {
                    console.error("Failed to fetch game data:", error);
                    loadingOverlay.innerHTML = `<p class="text-xl text-red-500">Failed to load data. Please refresh.</p>`;
                }
            }

            async function fetchMoveData(moveName) {
                if (moveDataCache.has(moveName)) return moveDataCache.get(moveName);
                if (sessionStorage.getItem(`move_${moveName}`)) {
                    const cached = JSON.parse(sessionStorage.getItem(`move_${moveName}`));
                    moveDataCache.set(moveName, cached);
                    return cached;
                }
                try {
                    const res = await fetch(`https://pokeapi.co/api/v2/move/${moveName}`);
                    const data = await res.json();
                    const moveDetails = { name: data.name, power: data.power, accuracy: data.accuracy, type: data.type.name, damage_class: GEN3_SPECIAL_TYPES.includes(data.type.name) ? 'special' : 'physical' };
                    moveDataCache.set(moveName, moveDetails);
                    sessionStorage.setItem(`move_${moveName}`, JSON.stringify(moveDetails));
                    return moveDetails;
                } catch (error) {
                    console.error(`Failed to fetch move data for ${moveName}:`, error);
                    return null;
                }
            }
            
            async function fetchExtraData(pokemon) {
                if (extraDataCache.has(pokemon.id)) return extraDataCache.get(pokemon.id);
                
                const cached = localStorage.getItem(`extraData_${pokemon.id}`);
                if (cached) {
                    const data = JSON.parse(cached);
                    extraDataCache.set(pokemon.id, data);
                    return data;
                }

                try {
                    const speciesPromise = fetch(`https://pokeapi.co/api/v2/pokemon-species/${pokemon.id}`).then(res => res.json());
                    // BUG FIX: Construct encounter URL manually to prevent errors with undefined URLs
                    const encounterPromise = fetch(`https://pokeapi.co/api/v2/pokemon/${pokemon.id}/encounters`).then(res => res.json());

                    const species = await speciesPromise;
                    if (!species.evolution_chain?.url) {
                         throw new Error("Evolution chain URL not found for " + pokemon.name);
                    }
                    const evolutionPromise = fetch(species.evolution_chain.url).then(res => res.json());

                    const [encountersData, evolutionData] = await Promise.all([encounterPromise, evolutionPromise]);

                    const locations = [];
                    encountersData.forEach(encounter => {
                        const hasEmeraldEncounter = encounter.version_details.some(detail => detail.version.name === 'emerald');
                        if (hasEmeraldEncounter) {
                            const locationName = encounter.location_area.name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            locations.push(locationName);
                        }
                    });

                    const parseEvolutionChain = (chainNode) => {
                        const chain = [];
                        const speciesName = chainNode.species.name;
                        const speciesId = chainNode.species.url.split('/').slice(-2, -1)[0];
                        
                        let method = "Base";
                        if (chainNode.evolution_details.length > 0) {
                             const evoDetails = chainNode.evolution_details[0];
                             const trigger = evoDetails.trigger.name.replace(/-/g, ' ');

                             switch(trigger) {
                                case 'level up':
                                    if (evoDetails.min_happiness) method = 'High Friendship';
                                    else if (evoDetails.min_level) method = `Level ${evoDetails.min_level}`;
                                    else method = 'Level Up';
                                    break;
                                case 'trade':
                                    method = 'Trade';
                                    break;
                                case 'use item':
                                    method = `Use ${evoDetails.item.name.replace(/-/g, ' ')}`;
                                    break;
                                default:
                                    method = trigger;
                            }
                        }
                        
                        chain.push({ name: speciesName, id: speciesId, method: method });

                        if (chainNode.evolves_to.length > 0) {
                            chainNode.evolves_to.forEach(evo => {
                                chain.push(...parseEvolutionChain(evo));
                            });
                        }
                        return chain;
                    };
                    
                    const evolutionChain = parseEvolutionChain(evolutionData.chain);
                    
                    const extraData = {
                        locations: [...new Set(locations)],
                        isBaby: species.is_baby,
                        isLegendary: species.is_legendary,
                        isMythical: species.is_mythical,
                        evolvesFrom: species.evolves_from_species ? species.evolves_from_species.name : null,
                        evolutionChain: evolutionChain
                    };

                    extraDataCache.set(pokemon.id, extraData);
                    localStorage.setItem(`extraData_${pokemon.id}`, JSON.stringify(extraData));
                    return extraData;
                } catch (error) {
                    console.error(`Failed to fetch extra data for ${pokemon.name}:`, error);
                    return { locations: [], isBaby: false, isLegendary: false, isMythical: false, evolvesFrom: null, evolutionChain: [] };
                }
            }


            function initializeApp() {
                populateTypeFilter();
                loadTeamFromStorage();
                renderPokemonList();
                renderTeam();
                setupMobileTabs();
                loadingOverlay.style.display = 'none';
            }

            // --- RENDER FUNCTIONS ---
            function populateTypeFilter() {
                Object.keys(TYPE_CHART).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                    typeFilter.appendChild(option);
                });
            }

            function renderPokemonList() {
                pokemonList.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                const selectedType = typeFilter.value;
                const filteredPokemon = allPokemonData.filter(p => p.name.toLowerCase().includes(searchTerm) && (selectedType === 'all' || p.types.includes(selectedType)));
                if (filteredPokemon.length === 0) {
                    pokemonList.innerHTML = `<p class="col-span-full text-center text-gray-400">No Pokémon found.</p>`;
                    return;
                }
                filteredPokemon.forEach(pokemon => {
                    const card = document.createElement('div');
                    card.className = 'pokemon-card p-2 rounded-lg text-center cursor-pointer';
                    card.innerHTML = `<img src="${pokemon.sprite}" alt="${pokemon.name}" class="mx-auto w-16 h-16 image-rendering-pixelated"><p class="text-sm capitalize mt-1">${pokemon.name}</p>`;
                    card.addEventListener('click', () => addPokemonToTeam(pokemon));
                    pokemonList.appendChild(card);
                });
            }

            function renderTeam() {
                teamContainer.innerHTML = '';
                team.forEach((pokemon, index) => {
                    const slot = document.createElement('div');
                    slot.className = 'team-slot relative p-4 rounded-lg flex flex-col items-center justify-center h-40 transition-all duration-200';
                    if (pokemon) {
                        slot.classList.add('pokemon-card', 'cursor-pointer');
                        const itemSprite = pokemon.heldItem && pokemon.heldItem !== 'none' ? `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${pokemon.heldItem}.png" class="absolute bottom-1 left-1 w-6 h-6 image-rendering-pixelated" alt="${pokemon.heldItem}" onerror="this.style.display='none'"/>` : '';
                        slot.innerHTML = `<img src="${pokemon.sprite}" alt="${pokemon.name}" class="w-20 h-20 image-rendering-pixelated mb-2"><p class="text-md capitalize text-center">${pokemon.nickname}</p><button class="remove-btn absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold opacity-50 hover:opacity-100 transition-opacity">×</button>${itemSprite}`;
                        slot.querySelector('.remove-btn').addEventListener('click', (e) => { e.stopPropagation(); removePokemonFromTeam(index); });
                        slot.addEventListener('click', () => {
                            displayPokemonDetails(pokemon, index);
                            if (window.innerWidth < 1024) {
                                switchView('details-view');
                            }
                        });
                    } else {
                        slot.classList.add('empty');
                        slot.innerHTML = `<span class="text-4xl text-gray-600">+</span>`;
                        slot.addEventListener('click', () => {
                             if (window.innerWidth < 1024) {
                                switchView('builder-view');
                            }
                            document.getElementById('pokemon-list-container').scrollIntoView({ behavior: 'smooth' });
                        });
                    }
                    teamContainer.appendChild(slot);
                });
                saveTeamToStorage();
                renderAllAnalyses();
            }

            async function displayPokemonDetails(pokemon, teamIndex = -1) {
                detailsPlaceholder.classList.add('hidden');
                detailsContent.classList.remove('hidden');
                const maxStatValue = 255;
                const itemOptions = Object.entries(HELD_ITEMS).map(([name, value]) => `<option value="${value}" ${pokemon.heldItem === value ? 'selected' : ''}>${name}</option>`).join('');
                const natureOptions = Object.keys(NATURES).map(name => `<option value="${name}" ${pokemon.nature === name ? 'selected' : ''}>${name}</option>`).join('');
                const abilityOptions = pokemon.abilities.map(name => `<option value="${name}" ${pokemon.selectedAbility === name ? 'selected' : ''}>${name.charAt(0).toUpperCase() + name.slice(1)}</option>`).join('');
                const selectedNature = NATURES[pokemon.nature];
                const abilityDesc = abilityDataCache.get(pokemon.selectedAbility)?.description || 'No description.';
                detailsContent.innerHTML = `
                    <div class="text-center">
                        <img src="${pokemon.sprite}" alt="${pokemon.name}" class="mx-auto w-24 h-24 image-rendering-pixelated">
                        <input type="text" id="nickname-input" value="${pokemon.nickname}" class="w-full bg-transparent text-2xl capitalize font-bold mt-2 text-center border-b-2 border-gray-700 focus:border-yellow-400 focus:outline-none">
                        <div class="flex justify-center gap-2 mt-2">${pokemon.types.map(type => `<span class="type-badge ${type}">${type}</span>`).join('')}</div>
                    </div>
                    <div class="mt-4"><h4 class="text-lg mb-2 text-xs">Ability</h4><select id="ability-select" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-yellow-400">${abilityOptions}</select><p id="ability-description" class="text-xs text-gray-400 mt-1 h-10">${abilityDesc}</p></div>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div><h4 class="text-lg mb-2 text-xs">Held Item</h4><select id="held-item-select" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-yellow-400">${itemOptions}</select></div>
                        <div><h4 class="text-lg mb-2 text-xs">Nature</h4><select id="nature-select" class="w-full p-2 rounded bg-gray-800 border border-gray-600 text-xs focus:outline-none focus:ring-2 focus:ring-yellow-400">${natureOptions}</select></div>
                    </div>
                    <div class="mt-4"><h4 class="text-lg mb-2">Base Stats</h4>${pokemon.stats.map(stat => {
                        let indicator = '';
                        if (selectedNature.inc === stat.name) indicator = '<span class="stat-up"> ▲</span>';
                        if (selectedNature.dec === stat.name) indicator = '<span class="stat-down"> ▼</span>';
                        return `<div class="flex items-center mb-1 text-xs"><span class="w-1/3 capitalize">${stat.name.replace('special-', 'Sp. ')}${indicator}</span><div class="w-2/3 stat-bar-bg rounded-full h-4"><div class="stat-bar h-4 rounded-full flex items-center justify-end pr-2" style="width: ${(stat.base_stat / maxStatValue) * 100}%"><span class="text-black text-shadow-none font-sans font-bold">${stat.base_stat}</span></div></div></div>`
                    }).join('')}</div>
                    <div class="mt-4"><h4 class="text-lg mb-2">Moves</h4><div id="team-member-moves" class="grid grid-cols-1 gap-2 text-sm">${renderSelectedMoves(pokemon)}</div></div>
                    <div id="extra-details-container" class="mt-4 space-y-2">
                        <h4 class="text-lg mb-2">Game Info</h4>
                        <div id="locations-container" class="text-xs text-gray-400 p-2 bg-gray-800 rounded">Loading locations...</div>
                        <div id="evolution-container" class="text-xs text-gray-400 p-2 bg-gray-800 rounded">Loading evolutions...</div>
                    </div>
                    ${teamIndex !== -1 ? `<button id="edit-moves-btn" class="w-full mt-4 text-md bg-yellow-500 text-black py-2 px-4 rounded hover:bg-yellow-400">Edit Moves</button>` : ''}`;
                
                if (teamIndex !== -1) {
                    document.getElementById('edit-moves-btn').addEventListener('click', () => openMoveModal(pokemon, teamIndex));
                    document.getElementById('nickname-input').addEventListener('input', (e) => {
                        team[teamIndex].nickname = e.target.value || team[teamIndex].name;
                        renderTeam();
                    });
                    document.getElementById('held-item-select').addEventListener('change', (e) => { team[teamIndex].heldItem = e.target.value; renderTeam(); });
                    document.getElementById('nature-select').addEventListener('change', (e) => { team[teamIndex].nature = e.target.value; displayPokemonDetails(team[teamIndex], teamIndex); saveTeamToStorage(); });
                    document.getElementById('ability-select').addEventListener('change', (e) => { team[teamIndex].selectedAbility = e.target.value; displayPokemonDetails(team[teamIndex], teamIndex); saveTeamToStorage(); });
                }

                const extraData = await fetchExtraData(pokemon);
                const locationsContainer = document.getElementById('locations-container');
                if (locationsContainer) {
                    if (extraData.locations.length > 0) {
                        locationsContainer.innerHTML = `<strong>Catchable At:</strong><ul class="list-disc list-inside ml-2 mt-1">${extraData.locations.map(loc => `<li>${loc}</li>`).join('')}</ul>`;
                    } else {
                         if (extraData.evolvesFrom) {
                            locationsContainer.textContent = 'Acquired through evolution.';
                        } else if (extraData.isLegendary || extraData.isMythical) {
                            locationsContainer.textContent = 'Acquired at a unique location.';
                        } else {
                            locationsContainer.textContent = 'Only available as a starter, gift, or special event.';
                        }
                    }
                }
                const evolutionContainer = document.getElementById('evolution-container');
                if (evolutionContainer) {
                    if (extraData.evolutionChain.length > 1) {
                        let evoHTML = '<strong>Evolutions:</strong><div class="flex items-center justify-center gap-1 mt-1 flex-wrap">';
                        const fullChain = extraData.evolutionChain;
                        for(let i=0; i < fullChain.length; i++) {
                            const evo = fullChain[i];
                            const spriteUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${evo.id}.png`;
                            evoHTML += `<div class="text-center"><img src="${spriteUrl}" class="w-16 h-16 image-rendering-pixelated" alt="${evo.name}"><p class="text-xs capitalize">${evo.name}</p></div>`;
                            
                            if (i < fullChain.length - 1) {
                                const nextEvo = fullChain[i+1];
                                if (nextEvo.method !== 'Base') {
                                    evoHTML += `<div class="text-center evolution-arrow mx-2"><p>&rarr;</p><p class="text-xs capitalize">${nextEvo.method.toLowerCase()}</p></div>`;
                                }
                            }
                        }
                        evoHTML += '</div>';
                        evolutionContainer.innerHTML = evoHTML;
                    } else {
                        evolutionContainer.textContent = 'This Pokémon does not evolve.';
                    }
                }
            }

            function renderSelectedMoves(pokemon) {
                if (pokemon.selectedMoves.length === 0) return '<p class="text-gray-500">No moves selected.</p>';
                return pokemon.selectedMoves.map(move => `<div class="bg-gray-700 p-2 rounded capitalize">${move.name}</div>`).join('');
            }

            function renderAllAnalyses() {
                const teamMembers = team.filter(p => p);
                if (teamMembers.length === 0) {
                    teamAnalysisContent.innerHTML = '<p class="text-center text-gray-500">Add Pokémon to your team to analyse its battle coverage.</p>';
                    return;
                }
                const defensive = {};
                Object.keys(TYPE_CHART).forEach(type => defensive[type] = { weak: 0, resist: 0, immune: 0 });
                for (const member of teamMembers) {
                    Object.entries(TYPE_CHART).forEach(([attackingType]) => {
                        let totalMultiplier = 1;
                        for (const defendingType of member.types) {
                            if (TYPE_CHART[defendingType].weak.includes(attackingType)) totalMultiplier *= 2;
                            if (TYPE_CHART[defendingType].resist.includes(attackingType)) totalMultiplier *= 0.5;
                            if (TYPE_CHART[defendingType].immune.includes(attackingType)) totalMultiplier *= 0;
                        }
                        if (totalMultiplier > 1) defensive[attackingType].weak++;
                        if (totalMultiplier < 1 && totalMultiplier > 0) defensive[attackingType].resist++;
                        if (totalMultiplier === 0) defensive[attackingType].immune++;
                    });
                }
                const defensiveHTML = `<div><h4 class="text-lg mb-2 text-center">Defensive Coverage</h4><div class="grid grid-cols-3 text-center mb-2 border-b border-gray-600 pb-1 text-xs"><span class="text-red-400">Weak To</span><span class="text-gray-400">Type</span><span class="text-green-400">Resists</span></div><div class="space-y-1 text-xs">${Object.keys(TYPE_CHART).map(type => `<div class="grid grid-cols-3 items-center"><div class="w-full bg-gray-700 rounded-full h-4"><div class="analysis-bar bg-red-600 h-4 rounded-full" style="width: ${defensive[type].weak / teamMembers.length * 100}%"></div></div><span class="type-badge ${type} mx-auto">${type}</span><div class="w-full bg-gray-700 rounded-full h-4"><div class="analysis-bar bg-green-600 h-4 rounded-full" style="width: ${(defensive[type].resist + defensive[type].immune) / teamMembers.length * 100}%"></div></div></div>`).join('')}</div></div>`;
                const offensive = {};
                Object.keys(TYPE_CHART).forEach(type => offensive[type] = 0);
                for (const member of teamMembers) {
                    const superEffectiveTypes = new Set();
                    for (const move of member.selectedMoves) {
                        Object.entries(TYPE_CHART).forEach(([defendingType, matchups]) => {
                            if (matchups.weak.includes(move.type)) {
                                superEffectiveTypes.add(defendingType);
                            }
                        });
                    }
                    superEffectiveTypes.forEach(type => offensive[type]++);
                }
                const offensiveHTML = `<div><h4 class="text-lg mb-2 mt-4 text-center">Offensive Coverage</h4><p class="text-xs text-center text-gray-500 mb-2">Team members with super-effective moves</p><div class="space-y-1 text-xs">${Object.keys(TYPE_CHART).map(type => `<div class="grid grid-cols-3 items-center"><span class="type-badge ${type} mx-auto">${type}</span><div class="w-full col-span-2 bg-gray-700 rounded-full h-4"><div class="analysis-bar bg-blue-500 h-4 rounded-full text-right pr-2 text-black font-sans font-bold flex items-center justify-end" style="width: ${offensive[type] / teamMembers.length * 100}%">${offensive[type]}</div></div></div>`).join('')}</div></div>`;
                teamAnalysisContent.innerHTML = defensiveHTML + offensiveHTML;
            }

            // --- TEAM LOGIC ---
            function addPokemonToTeam(pokemon) {
                const emptySlotIndex = team.findIndex(slot => slot === null);
                if (emptySlotIndex !== -1) {
                    team[emptySlotIndex] = JSON.parse(JSON.stringify(pokemon));
                    renderTeam();
                    displayPokemonDetails(team[emptySlotIndex], emptySlotIndex);
                    showToast(`${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)} added to team!`);
                    if (window.innerWidth < 1024) {
                        switchView('details-view');
                    }
                } else {
                    showToast("Your team is full!", 'error');
                }
            }

            function removePokemonFromTeam(index) {
                const removedPokemonName = team[index].nickname;
                team[index] = null;
                renderTeam();
                if (detailsContent.querySelector('#nickname-input')?.value === removedPokemonName) {
                    detailsContent.classList.add('hidden');
                    detailsPlaceholder.classList.remove('hidden');
                }
            }

            // --- MOVE MODAL LOGIC ---
            async function openMoveModal(pokemon, teamIndex) {
                modalContent.innerHTML = `<div class="text-center text-xl">Loading moves...</div>`;
                moveModal.classList.remove('hidden');
                modalBackdrop.classList.add('opacity-100');
                modalPanel.classList.add('scale-100');

                const allMoveDetailsPromises = pokemon.moves.map(move => fetchMoveData(move.name));
                const allMoveDetails = (await Promise.all(allMoveDetailsPromises)).filter(Boolean);

                const getMoveDetails = (name) => allMoveDetails.find(m => m.name === name);

                modalContent.innerHTML = `
                    <h3 class="text-xl capitalize mb-4 text-center">Select Moves for ${pokemon.nickname}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg mb-2">Available Moves</h4>
                            <div id="available-moves-container" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                        </div>
                        <div>
                            <h4 class="text-lg mb-2">Selected Moves (<span id="selected-moves-count">${pokemon.selectedMoves.length}</span> / 4)</h4>
                            <div id="current-selected-moves" class="space-y-2 min-h-[160px]"></div>
                        </div>
                    </div>`;

                const renderMoveList = () => {
                    const availableMovesContainer = document.getElementById('available-moves-container');
                    
                    const levelUpMoves = pokemon.moves.filter(m => m.method === 'level-up' && m.level > 0);
                    const machineMoves = pokemon.moves.filter(m => m.method === 'machine');
                    const tutorMoves = pokemon.moves.filter(m => m.method === 'tutor');

                    const createMoveButton = (move) => {
                        const details = getMoveDetails(move.name);
                        if (!details) return '';
                        const isSelected = pokemon.selectedMoves.some(m => m.name === move.name);
                        let levelInfo = '';
                        if (move.method === 'level-up') {
                            levelInfo = `<span class="text-xs text-gray-400 w-12 text-right">Lvl ${move.level}</span>`;
                        }
                        return `<button class="w-full p-2 rounded capitalize text-left text-sm flex justify-between items-center ${isSelected ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-600'}" data-move-name="${move.name}" ${isSelected ? 'disabled' : ''}>
                                    <span class="flex-grow">${move.name}</span>
                                    <span class="type-badge ${details.type} mx-2">${details.damage_class.slice(0,3)}</span>
                                    ${levelInfo}
                                </button>`;
                    };
                    
                    availableMovesContainer.innerHTML = `
                        <details open><summary>Level Up</summary><div class="space-y-1 p-2 bg-gray-800 rounded-b-md">${levelUpMoves.map(createMoveButton).join('') || '<p class="text-xs text-gray-500 p-2">None</p>'}</div></details>
                        <details><summary>TM / HM</summary><div class="space-y-1 p-2 bg-gray-800 rounded-b-md">${machineMoves.map(createMoveButton).join('') || '<p class="text-xs text-gray-500 p-2">None</p>'}</div></details>
                        <details><summary>Tutor</summary><div class="space-y-1 p-2 bg-gray-800 rounded-b-md">${tutorMoves.map(createMoveButton).join('') || '<p class="text-xs text-gray-500 p-2">None</p>'}</div></details>
                    `;
                    
                    availableMovesContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => selectMove(getMoveDetails(btn.dataset.moveName))));
                };

                const renderSelected = () => {
                    const currentMovesContainer = document.getElementById('current-selected-moves');
                    document.getElementById('selected-moves-count').textContent = pokemon.selectedMoves.length;
                    currentMovesContainer.innerHTML = pokemon.selectedMoves.map(move => `
                        <div class="bg-blue-800 p-2 rounded capitalize text-sm">
                            <div class="flex justify-between items-center">
                                <span>${move.name}</span>
                                <button class="text-red-300 hover:text-red-100 font-bold" data-move-name="${move.name}">×</button>
                            </div>
                            <div class="text-xs text-gray-300 mt-1 flex justify-between">
                                <span class="type-badge ${move.type}">${move.type}</span>
                                <span>Pow: ${move.power || '--'}</span>
                                <span>Acc: ${move.accuracy || '--'}</span>
                                <span class="capitalize">${move.damage_class}</span>
                            </div>
                        </div>`).join('');
                    currentMovesContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => deselectMove(btn.dataset.moveName)));
                };

                const selectMove = (move) => { if (pokemon.selectedMoves.length < 4) { pokemon.selectedMoves.push(move); updateAndRerender(); } };
                const deselectMove = (moveName) => { pokemon.selectedMoves = pokemon.selectedMoves.filter(m => m.name !== moveName); updateAndRerender(); };
                const updateAndRerender = () => { 
                    team[teamIndex] = pokemon; 
                    renderSelected(); 
                    renderMoveList(); 
                    displayPokemonDetails(pokemon, teamIndex); 
                    renderAllAnalyses(); 
                    saveTeamToStorage(); 
                };

                renderSelected();
                renderMoveList();
            }

            function closeModal() {
                modalBackdrop.classList.remove('opacity-100');
                modalPanel.classList.remove('scale-100');
                setTimeout(() => moveModal.classList.add('hidden'), 300);
            }

            // --- LOCAL STORAGE ---
            function saveTeamToStorage() {
                localStorage.setItem('pokemonEmeraldTeam', JSON.stringify(team));
            }

            function loadTeamFromStorage() {
                const savedTeam = localStorage.getItem('pokemonEmeraldTeam');
                if (savedTeam) {
                    const parsedTeam = JSON.parse(savedTeam);
                    team = parsedTeam.map(p => {
                        if (p) {
                            return {
                                heldItem: 'none',
                                nature: 'Hardy',
                                selectedAbility: p.abilities ? p.abilities[0] : null,
                                nickname: p.name,
                                ...p,
                            };
                        }
                        return p;
                    });
                }
            }
            
            // --- UI HELPERS ---
            function showToast(message, type = 'success') {
                toastMessage.textContent = message;
                toast.className = `fixed bottom-20 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 toast z-40 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                
                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-2');
                    toast.classList.add('opacity-100', 'translate-y-0');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-2');
                }, 3000);
            }

            function switchView(viewId) {
                document.querySelectorAll('.view-panel').forEach(panel => {
                    panel.classList.add('hidden');
                    panel.classList.remove('lg:block');
                });
                document.getElementById(viewId).classList.remove('hidden');

                document.querySelectorAll('.mobile-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`.mobile-tab[data-view="${viewId}"]`).classList.add('active');
            }

            function setupMobileTabs() {
                const tabs = document.querySelectorAll('.mobile-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        switchView(tab.dataset.view);
                    });
                });
                switchView('builder-view');
            }

            // --- EVENT LISTENERS ---
            searchInput.addEventListener('input', renderPokemonList);
            typeFilter.addEventListener('change', renderPokemonList);
            closeModalBtn.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', closeModal);
            clearTeamBtn.addEventListener('click', () => {
                team.fill(null);
                renderTeam();
                detailsContent.classList.add('hidden');
                detailsPlaceholder.classList.remove('hidden');
                showToast("Team cleared!", "success");
            });

            // --- STARTUP ---
            fetchGameData().then(initializeApp);
        });
    </script>
</body>
</html>
